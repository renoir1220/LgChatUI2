# 后台管理页面开发计划（AI执行用）

目标
- 构建一个简洁的后台管理骨架：左侧导航（管理目录），右侧功能区。
- 首个菜单为「新闻管理」（仅占位组件，无实际业务）。
- 权限极简：本地可热加载配置，配置了管理员姓名即可看到并访问全部后台菜单；非管理员不可见。
- 所有数据访问走 lgchatui data service；涉及建表的 SQL 统一输出到 `backend/sql/` 目录。
- 严格后端优先：后端完成并通过自测后，再开发前端。

技术选型与规范（二次确认）
- 前端：React + shadcn/ui + Tailwind（与现有前端一致），不引入其他 UI 框架；导航布局和基础组件统一采用 shadcn 风格（Sidebar、Button、Tabs、Table 占位等）。
- 后端：NestJS（与现有代码保持一致），模块化（Module/Controller/Service/Guard），日志用 `AppLoggerService`，校验沿用 `ZodValidationPipe` 方案，错误处理与返回格式保持与现有接口一致。
- 代码风格：后端参考会话 repo 的现有风格与目录结构（features/*、shared/* 模块边界清晰），命名与文件布局保持统一，不做超出当前项目范式的自定义基础设施。

约束与风格
- 保持简单，避免过度设计与无必要功能。
- 仅区分「管理员 / 非管理员」，不做多级角色/细粒度权限。
- 配置热加载，不需重启 Docker（文件改动即时生效）。

总体架构
- 新增 `AdminModule`（NestJS）：
  - `AdminConfigService`：读取/监控本地管理员配置；提供 `isAdmin(username)` 能力。
  - `AdminGuard`：基于 `JwtAuthGuard` 后判断是否管理员，保护后台接口。
  - `AdminController`：
    - `GET /api/admin/permissions/me` → `{ isAdmin: boolean }`
    - `GET /api/admin/menus`（受保护）→ 返回后台菜单（先返回「新闻管理」）。
    - `GET /api/admin/ping`（受保护）→ 简单健康检查，便于前端联通。
  - 预留 `NewsAdminController`（受保护）：先返回占位数据。
- 配置文件：`backend/config/admins.txt`（UTF-8，逗号分隔多个姓名），例如：`张三,李四,王五`。
  - 可通过 `ADMIN_CONFIG_PATH` 环境变量覆盖默认路径。
  - 通过 `fs.watch` + 去抖动热加载（更新内存 Set）。

执行步骤（后端优先）
1) 新增配置与服务
- 创建 `backend/config/admins.txt`（提交一个示例内容，供自测）。
- 新建 `AdminConfigService`：
  - 从 `process.env.ADMIN_CONFIG_PATH || ./config/admins.txt` 读取；解析为 Set（去空白，忽略空项）。
  - 监听文件变化，去抖动 200ms，自动刷新内存数据。
  - 暴露 `isAdmin(username: string): boolean`。

2) 接入鉴权与守卫
- 新建 `AdminGuard`：依赖 `JwtAuthGuard` 之后，从 `req.user.username` 判断 `isAdmin`，否则 403。
- 将 `AdminModule` 注册到 `AppModule`。

3) 后台控制器与占位接口
- `AdminController`：
  - `GET /api/admin/permissions/me`（需登录，不需管理员）→ 返回 `{ isAdmin }`。
  - `GET /api/admin/menus`（仅管理员）→ 返回固定菜单：`[{ key: 'news', label: '新闻管理' }]`。
  - `GET /api/admin/ping`（仅管理员）→ `{ ok: true }`。
- `NewsAdminController`（仅管理员）：
  - `GET /api/admin/news` → 返回空列表与分页占位：`{ data: [], pagination: { total: 0 } }`。
  - 预留增删改查路由但返回 501 或占位响应（暂不实现具体逻辑）。
- 数据访问：如需调用数据库，统一通过 lgchatui data service 注入（本期先不落库）。

4) 后端自测与校验
- 用示例 `admins.txt` 启动后：
  - 登录获取 JWT，访问 `/api/admin/permissions/me` 应返回 `isAdmin` 正确。
  - `admins.txt` 动态增删姓名，数秒内再次请求应反映最新权限（验证热加载）。
  - 非管理员访问 `/api/admin/menus`、`/api/admin/ping` 返回 403；管理员返回 200。

5) 前端骨架（后端通过后再做）
- 入口：聊天界面 → 用户信息二级菜单里新增「后台管理」，仅当 `isAdmin` 为 true 时展示（请求 `/api/admin/permissions/me`）。
- 布局：左侧固定导航（「新闻管理」），右侧功能区（渲染内容）。
- 路由：`/admin`（或在现有壳内弹层/页签，保持简单）。
- 组件：
  - `AdminShell`：统一布局（侧边栏 + 内容）。
  - `AdminMenu`：渲染后端返回的菜单；当前仅「新闻管理」。
  - `NewsAdminPage`：占位页（空表格/空状态 + 文案）。
- 不做多余：不接入状态管理库，不做菜单配置化；简单直连 API。

6) SQL 输出（如后续需要建表）
- 将新闻相关的表结构 SQL 输出至 `backend/sql/news/*.sql`，由运营方执行。
- 示例：`backend/sql/news/create_news_tables.sql`（后续落地功能时再补）。

接口约定（当前）
- `GET /api/admin/permissions/me` → `{ isAdmin: boolean }`（登录必需）。
- `GET /api/admin/menus` → `[{ key: string, label: string }]`（管理员）。
- `GET /api/admin/ping` → `{ ok: true }`（管理员）。
- `GET /api/admin/news` → `{ data: any[], pagination: { total: number } }`（管理员，占位）。

回滚与安全
- 配置读取失败时，`isAdmin` 一律为 false（默认安全）。
- 无法监控文件时记录日志并定时轮询（后续需要时再加；本期先用 fs.watch）。

完成判据（本阶段）
- 后端：权限接口和菜单接口工作正常；配置热加载有效；非管理员无法访问受保护接口。
- 前端：存在可进入的后台骨架页；仅管理员可见菜单；「新闻管理」占位页能正确显示。
