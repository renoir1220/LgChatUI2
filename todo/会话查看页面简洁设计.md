# 会话查看页面简洁设计

## 1. 页面布局

### 1.1 整体布局
```
┌─────────────────────────────────────────────────────────┐
│                    顶部过滤条                             │
├─────────────────────┬───────────────────────────────────┤
│                     │                                   │
│     左侧会话列表     │          右侧消息详情              │
│                     │                                   │
│  - 按最后对话时间   │    选中会话的完整对话记录           │
│    倒序排列         │                                   │
│  - 显示用户评价     │                                   │
│  - 显示基本信息     │                                   │
│                     │                                   │
└─────────────────────┴───────────────────────────────────┘
```

### 1.2 左右布局比例
- 左侧列表：30% 宽度
- 右侧详情：70% 宽度

## 2. 左侧会话列表

### 2.1 列表项内容
```typescript
interface ConversationListItem {
  id: string;
  title: string;                    // 会话标题
  username: string;                 // 用户名
  lastMessageAt: string;            // 最后对话时间
  messageCount: number;             // 消息数量
  knowledgeBaseName?: string;       // 知识库名称
  likeCount: number;                // 点赞数
  dislikeCount: number;             // 踩数
  hasPositiveFeedback: boolean;     // 是否有点赞
  hasNegativeFeedback: boolean;     // 是否有踩
}
```

### 2.2 列表项显示样式
```
┌─────────────────────────────────┐
│ 用户名                👍 3 👎 1 │
│ 会话标题（截断显示）              │
│ 知识库 | 5条消息 | 2小时前        │
└─────────────────────────────────┘
```

### 2.3 排序规则
- 默认按 `lastMessageAt` 倒序排列
- 支持按评分排序

## 3. 基础过滤功能

### 3.1 顶部过滤条
```typescript
interface ConversationFilters {
  feedbackFilter?: 'all' | 'liked' | 'disliked';  // 反馈过滤：全部|有赞|有踩
  knowledgeBaseId?: string;                        // 知识库过滤
  dateRange?: {                                    // 时间范围
    startDate?: string;
    endDate?: string;
  };
  searchText?: string;                             // 搜索关键词
}
```

### 3.2 过滤器布局
```
[搜索框] [反馈筛选] [知识库筛选] [时间范围] [重置]
```

### 3.3 反馈过滤逻辑
- **有赞**：会话中至少有一条消息被用户点赞
- **有踩**：会话中至少有一条消息被用户踩

## 4. 右侧消息详情

### 4.1 消息显示格式
```typescript
interface MessageDisplay {
  id: string;
  role: 'USER' | 'ASSISTANT';
  content: string;
  createdAt: string;
  userRating?: number;              // 用户对该回答的评分
  userFeedback?: string;            // 用户反馈内容
}
```

### 4.2 消息样式
- 用户消息：右对齐，蓝色气泡
- AI回答：左对齐，灰色气泡
- 如有评分，在AI回答下方显示星级评分
- 如有反馈，显示用户的文字评价

## 5. 后端API设计

### 5.1 会话列表API
```
GET /api/admin/conversations

查询参数：
- page: 页码（默认1）
- pageSize: 每页大小（默认50，可选：25、50、100、200）
- feedbackFilter: 反馈筛选
- knowledgeBaseId: 知识库ID
- startDate: 开始时间
- endDate: 结束时间
- search: 搜索关键词

响应：
{
  conversations: ConversationListItem[],
  pagination: { page, pageSize, total, totalPages }
}
```

### 5.2 会话详情API
```
GET /api/admin/conversations/:id/messages

响应：
{
  conversation: ConversationInfo,
  messages: MessageDisplay[]
}
```

## 6. 前端组件结构

### 6.1 主页面组件
```
ConversationViewerPage.tsx
├── ConversationFilters.tsx        # 顶部过滤条
├── ConversationList.tsx           # 左侧会话列表
└── ConversationDetail.tsx         # 右侧消息详情
```

### 6.2 组件职责
- **ConversationViewerPage**: 状态管理和布局
- **ConversationFilters**: 过滤条件和搜索
- **ConversationList**: 会话列表展示和选择
- **ConversationDetail**: 消息详情展示

## 7. 数据库查询优化

### 7.1 主查询SQL
```sql
SELECT
  c.id,
  c.title,
  c.userId,
  u.EMPLOYEE_NAME as username,
  c.lastMessageAt,
  COUNT(m.id) as messageCount,
  kb.name as knowledgeBaseName,
  AVG(CAST(f.rating as FLOAT)) as averageRating,
  COUNT(CASE WHEN f.rating < 3 THEN 1 END) as negativeCount
FROM AI_CONVERSATIONS c
LEFT JOIN CRM.VIEW_EMPLOYEE u ON c.userId = u.CRM_USER_ID
LEFT JOIN AI_MESSAGES m ON c.id = m.conversationId
LEFT JOIN AI_MESSAGE_FEEDBACK f ON m.id = f.messageId
LEFT JOIN AI_KNOWLEDGE_BASES kb ON c.knowledgeBaseId = kb.id
WHERE 1=1
  ${ratingFilter}
  ${knowledgeBaseFilter}
  ${dateRangeFilter}
  ${searchFilter}
GROUP BY c.id, c.title, c.userId, u.EMPLOYEE_NAME, c.lastMessageAt, kb.name
ORDER BY c.lastMessageAt DESC
LIMIT @pageSize OFFSET @offset
```

### 7.2 评价过滤条件
```sql
-- 好评过滤
AND (AVG(CAST(f.rating as FLOAT)) >= 4.0 OR AVG(CAST(f.rating as FLOAT)) IS NULL)

-- 差评过滤
AND (AVG(CAST(f.rating as FLOAT)) < 3.0 OR COUNT(CASE WHEN f.rating < 3 THEN 1 END) > 0)
```

## 8. 实现要点

### 8.1 性能考虑
- 会话列表分页加载（每页20条）
- 消息详情按需加载
- 合理的数据库索引策略
bu
### 8.2 用户体验
- 左侧列表选中高亮
- 右侧消息支持滚动查看
- 过滤条件实时生效
- 移动端响应式适配

### 8.3 安全要求
- 继承现有的AdminGuard权限验证
- 记录管理员查看操作日志
- 数据脱敏显示（如需要）

---

**设计原则**：
- **简洁实用**：聚焦核心功能，避免过度设计
- **性能优先**：合理的分页和查询优化
- **体验友好**：直观的布局和交互方式
- **易于实现**：基于现有架构的渐进式开发