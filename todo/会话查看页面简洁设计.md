# ä¼šè¯æŸ¥çœ‹é¡µé¢ç®€æ´è®¾è®¡

## 1. é¡µé¢å¸ƒå±€

### 1.1 æ•´ä½“å¸ƒå±€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é¡¶éƒ¨è¿‡æ»¤æ¡                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚                                   â”‚
â”‚     å·¦ä¾§ä¼šè¯åˆ—è¡¨     â”‚          å³ä¾§æ¶ˆæ¯è¯¦æƒ…              â”‚
â”‚                     â”‚                                   â”‚
â”‚  - æŒ‰æœ€åå¯¹è¯æ—¶é—´   â”‚    é€‰ä¸­ä¼šè¯çš„å®Œæ•´å¯¹è¯è®°å½•           â”‚
â”‚    å€’åºæ’åˆ—         â”‚                                   â”‚
â”‚  - æ˜¾ç¤ºç”¨æˆ·è¯„ä»·     â”‚                                   â”‚
â”‚  - æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯     â”‚                                   â”‚
â”‚                     â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å·¦å³å¸ƒå±€æ¯”ä¾‹
- å·¦ä¾§åˆ—è¡¨ï¼š30% å®½åº¦
- å³ä¾§è¯¦æƒ…ï¼š70% å®½åº¦

## 2. å·¦ä¾§ä¼šè¯åˆ—è¡¨

### 2.1 åˆ—è¡¨é¡¹å†…å®¹
```typescript
interface ConversationListItem {
  id: string;
  title: string;                    // ä¼šè¯æ ‡é¢˜
  username: string;                 // ç”¨æˆ·å
  lastMessageAt: string;            // æœ€åå¯¹è¯æ—¶é—´
  messageCount: number;             // æ¶ˆæ¯æ•°é‡
  knowledgeBaseName?: string;       // çŸ¥è¯†åº“åç§°
  likeCount: number;                // ç‚¹èµæ•°
  dislikeCount: number;             // è¸©æ•°
  hasPositiveFeedback: boolean;     // æ˜¯å¦æœ‰ç‚¹èµ
  hasNegativeFeedback: boolean;     // æ˜¯å¦æœ‰è¸©
}
```

### 2.2 åˆ—è¡¨é¡¹æ˜¾ç¤ºæ ·å¼
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·å                ğŸ‘ 3 ğŸ‘ 1 â”‚
â”‚ ä¼šè¯æ ‡é¢˜ï¼ˆæˆªæ–­æ˜¾ç¤ºï¼‰              â”‚
â”‚ çŸ¥è¯†åº“ | 5æ¡æ¶ˆæ¯ | 2å°æ—¶å‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ’åºè§„åˆ™
- é»˜è®¤æŒ‰ `lastMessageAt` å€’åºæ’åˆ—
- æ”¯æŒæŒ‰è¯„åˆ†æ’åº

## 3. åŸºç¡€è¿‡æ»¤åŠŸèƒ½

### 3.1 é¡¶éƒ¨è¿‡æ»¤æ¡
```typescript
interface ConversationFilters {
  feedbackFilter?: 'all' | 'liked' | 'disliked';  // åé¦ˆè¿‡æ»¤ï¼šå…¨éƒ¨|æœ‰èµ|æœ‰è¸©
  knowledgeBaseId?: string;                        // çŸ¥è¯†åº“è¿‡æ»¤
  dateRange?: {                                    // æ—¶é—´èŒƒå›´
    startDate?: string;
    endDate?: string;
  };
  searchText?: string;                             // æœç´¢å…³é”®è¯
}
```

### 3.2 è¿‡æ»¤å™¨å¸ƒå±€
```
[æœç´¢æ¡†] [åé¦ˆç­›é€‰] [çŸ¥è¯†åº“ç­›é€‰] [æ—¶é—´èŒƒå›´] [é‡ç½®]
```

### 3.3 åé¦ˆè¿‡æ»¤é€»è¾‘
- **æœ‰èµ**ï¼šä¼šè¯ä¸­è‡³å°‘æœ‰ä¸€æ¡æ¶ˆæ¯è¢«ç”¨æˆ·ç‚¹èµ
- **æœ‰è¸©**ï¼šä¼šè¯ä¸­è‡³å°‘æœ‰ä¸€æ¡æ¶ˆæ¯è¢«ç”¨æˆ·è¸©

## 4. å³ä¾§æ¶ˆæ¯è¯¦æƒ…

### 4.1 æ¶ˆæ¯æ˜¾ç¤ºæ ¼å¼
```typescript
interface MessageDisplay {
  id: string;
  role: 'USER' | 'ASSISTANT';
  content: string;
  createdAt: string;
  userRating?: number;              // ç”¨æˆ·å¯¹è¯¥å›ç­”çš„è¯„åˆ†
  userFeedback?: string;            // ç”¨æˆ·åé¦ˆå†…å®¹
}
```

### 4.2 æ¶ˆæ¯æ ·å¼
- ç”¨æˆ·æ¶ˆæ¯ï¼šå³å¯¹é½ï¼Œè“è‰²æ°”æ³¡
- AIå›ç­”ï¼šå·¦å¯¹é½ï¼Œç°è‰²æ°”æ³¡
- å¦‚æœ‰è¯„åˆ†ï¼Œåœ¨AIå›ç­”ä¸‹æ–¹æ˜¾ç¤ºæ˜Ÿçº§è¯„åˆ†
- å¦‚æœ‰åé¦ˆï¼Œæ˜¾ç¤ºç”¨æˆ·çš„æ–‡å­—è¯„ä»·

## 5. åç«¯APIè®¾è®¡

### 5.1 ä¼šè¯åˆ—è¡¨API
```
GET /api/admin/conversations

æŸ¥è¯¢å‚æ•°ï¼š
- page: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- pageSize: æ¯é¡µå¤§å°ï¼ˆé»˜è®¤50ï¼Œå¯é€‰ï¼š25ã€50ã€100ã€200ï¼‰
- feedbackFilter: åé¦ˆç­›é€‰
- knowledgeBaseId: çŸ¥è¯†åº“ID
- startDate: å¼€å§‹æ—¶é—´
- endDate: ç»“æŸæ—¶é—´
- search: æœç´¢å…³é”®è¯

å“åº”ï¼š
{
  conversations: ConversationListItem[],
  pagination: { page, pageSize, total, totalPages }
}
```

### 5.2 ä¼šè¯è¯¦æƒ…API
```
GET /api/admin/conversations/:id/messages

å“åº”ï¼š
{
  conversation: ConversationInfo,
  messages: MessageDisplay[]
}
```

## 6. å‰ç«¯ç»„ä»¶ç»“æ„

### 6.1 ä¸»é¡µé¢ç»„ä»¶
```
ConversationViewerPage.tsx
â”œâ”€â”€ ConversationFilters.tsx        # é¡¶éƒ¨è¿‡æ»¤æ¡
â”œâ”€â”€ ConversationList.tsx           # å·¦ä¾§ä¼šè¯åˆ—è¡¨
â””â”€â”€ ConversationDetail.tsx         # å³ä¾§æ¶ˆæ¯è¯¦æƒ…
```

### 6.2 ç»„ä»¶èŒè´£
- **ConversationViewerPage**: çŠ¶æ€ç®¡ç†å’Œå¸ƒå±€
- **ConversationFilters**: è¿‡æ»¤æ¡ä»¶å’Œæœç´¢
- **ConversationList**: ä¼šè¯åˆ—è¡¨å±•ç¤ºå’Œé€‰æ‹©
- **ConversationDetail**: æ¶ˆæ¯è¯¦æƒ…å±•ç¤º

## 7. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

### 7.1 ä¸»æŸ¥è¯¢SQL
```sql
SELECT
  c.id,
  c.title,
  c.userId,
  u.EMPLOYEE_NAME as username,
  c.lastMessageAt,
  COUNT(m.id) as messageCount,
  kb.name as knowledgeBaseName,
  AVG(CAST(f.rating as FLOAT)) as averageRating,
  COUNT(CASE WHEN f.rating < 3 THEN 1 END) as negativeCount
FROM AI_CONVERSATIONS c
LEFT JOIN CRM.VIEW_EMPLOYEE u ON c.userId = u.CRM_USER_ID
LEFT JOIN AI_MESSAGES m ON c.id = m.conversationId
LEFT JOIN AI_MESSAGE_FEEDBACK f ON m.id = f.messageId
LEFT JOIN AI_KNOWLEDGE_BASES kb ON c.knowledgeBaseId = kb.id
WHERE 1=1
  ${ratingFilter}
  ${knowledgeBaseFilter}
  ${dateRangeFilter}
  ${searchFilter}
GROUP BY c.id, c.title, c.userId, u.EMPLOYEE_NAME, c.lastMessageAt, kb.name
ORDER BY c.lastMessageAt DESC
LIMIT @pageSize OFFSET @offset
```

### 7.2 è¯„ä»·è¿‡æ»¤æ¡ä»¶
```sql
-- å¥½è¯„è¿‡æ»¤
AND (AVG(CAST(f.rating as FLOAT)) >= 4.0 OR AVG(CAST(f.rating as FLOAT)) IS NULL)

-- å·®è¯„è¿‡æ»¤
AND (AVG(CAST(f.rating as FLOAT)) < 3.0 OR COUNT(CASE WHEN f.rating < 3 THEN 1 END) > 0)
```

## 8. å®ç°è¦ç‚¹

### 8.1 æ€§èƒ½è€ƒè™‘
- ä¼šè¯åˆ—è¡¨åˆ†é¡µåŠ è½½ï¼ˆæ¯é¡µ20æ¡ï¼‰
- æ¶ˆæ¯è¯¦æƒ…æŒ‰éœ€åŠ è½½
- åˆç†çš„æ•°æ®åº“ç´¢å¼•ç­–ç•¥
bu
### 8.2 ç”¨æˆ·ä½“éªŒ
- å·¦ä¾§åˆ—è¡¨é€‰ä¸­é«˜äº®
- å³ä¾§æ¶ˆæ¯æ”¯æŒæ»šåŠ¨æŸ¥çœ‹
- è¿‡æ»¤æ¡ä»¶å®æ—¶ç”Ÿæ•ˆ
- ç§»åŠ¨ç«¯å“åº”å¼é€‚é…

### 8.3 å®‰å…¨è¦æ±‚
- ç»§æ‰¿ç°æœ‰çš„AdminGuardæƒé™éªŒè¯
- è®°å½•ç®¡ç†å‘˜æŸ¥çœ‹æ“ä½œæ—¥å¿—
- æ•°æ®è„±æ•æ˜¾ç¤ºï¼ˆå¦‚éœ€è¦ï¼‰

---

**è®¾è®¡åŸåˆ™**ï¼š
- **ç®€æ´å®ç”¨**ï¼šèšç„¦æ ¸å¿ƒåŠŸèƒ½ï¼Œé¿å…è¿‡åº¦è®¾è®¡
- **æ€§èƒ½ä¼˜å…ˆ**ï¼šåˆç†çš„åˆ†é¡µå’ŒæŸ¥è¯¢ä¼˜åŒ–
- **ä½“éªŒå‹å¥½**ï¼šç›´è§‚çš„å¸ƒå±€å’Œäº¤äº’æ–¹å¼
- **æ˜“äºå®ç°**ï¼šåŸºäºç°æœ‰æ¶æ„çš„æ¸è¿›å¼å¼€å‘