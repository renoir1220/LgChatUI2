# 新闻管理开发计划（后端优先，简洁实现）

目标
- 后台页面中新增“新闻管理”：支持列表查询（标题模糊 + 分类/状态过滤）、删除、创建/编辑（Markdown 编辑与预览），并可在列表与详情中切换状态。
- 渲染与信息流 InfoFeed 详情共用（feed-markdown.css + ReactMarkdown 组件），实现“所见即所得”的预览一致性。
- 保持简单，避免过度设计；权限依旧走 AdminGuard；数据访问走 lgchatui data service。

技术与风格
- 后端：NestJS（与会话模块风格一致），接口挂载在 `/api/admin/news/*`，仅管理员可访问。
- 前端：React + Tailwind + shadcn/ui；后台壳体已就位（AdminApp + AdminSidebar）。
- 状态统一：沿用 InfoFeedStatus 枚举的语义（draft/published/archived），在前后端共享同一套值（参考 frontend/src/types/infofeed.ts 的 InfoFeedStatus）。

执行顺序（后端优先）
1) 数据库与表结构（输出 SQL，先不改动代码）
- 输出到 `backend/sql/news/create_news_tables.sql`，由维护者执行：
  - 表 `AI_NEWS`（示例字段）：
    - id (bigint identity, PK)
    - title (nvarchar(200) not null)
    - content_md (nvarchar(max) not null)
    - summary (nvarchar(500) null)
    - category (nvarchar(50) null)           // 分类键，可空
    - status (nvarchar(20) not null)         // draft/published/archived
    - thumbnail_url (nvarchar(500) null)
    - author_name (nvarchar(100) null)
    - publish_time (datetime null)
    - created_at (datetime not null, default getdate())
    - updated_at (datetime not null, default getdate())
    - indexes: IX_AI_NEWS_Title (title), IX_AI_NEWS_Status (status), IX_AI_NEWS_Category (category)

2) 后端 API（NestJS，AdminModule 内新增 News 控制器/服务）
- 路由前缀：`/api/admin/news`
- 列表查询 GET `/`：
  - query: `q`（标题模糊）, `category`, `status`, `page`, `limit`, `order_by`(publish_time|updated_at), `order_direction`(ASC|DESC)
  - 返回：`{ data: News[], pagination: {...} }`
- 详情 GET `/:id`：返回单条新闻（含 content_md 等）
- 创建 POST `/`：`{ title, content_md, summary?, category?, status, thumbnail_url?, publish_time? }` → 返回新 id
- 更新 PUT `/:id`：同上（全量或部分字段）
- 删除 DELETE `/:id`
- 切换状态 PUT `/:id/status`：`{ status }`（与前端统一使用 InfoFeedStatus 值）
- 图片上传 POST `/upload`：multipart/form-data，字段名 `image`（或 `images[]`），返回 `{ url }[]`；保存到 `/uploads/news/yyyy/mm/uuid.ext`，URL 返回 `/uploads/news/...`
- 守卫：全部接口加 `@UseGuards(JwtAuthGuard, AdminGuard)`
- 注意：数据访问通过 lgchatui data service（LgChatUIDatabaseService），SQL 参数化，分页与总数查询。

3) 前端页面（shadcn + 共用渲染）
- 入口：Admin 左栏菜单已有“新闻管理”（来自后端 `/api/admin/menus`）
- 列表页（`/admin/news`）：
  - 顶部工具栏：搜索（标题关键字）、分类下拉、状态下拉、刷新、新建按钮
  - 表格：标题、分类、状态、发布时间/更新时间、操作（编辑、删除、状态切换）
  - 删除：AlertDialog 二次确认
  - 状态切换：行内下拉或按钮（保持简单）
- 编辑页（`/admin/news/new`、`/admin/news/:id/edit`）：
  - 表单：标题、分类、状态、发布时间（可选）
  - Markdown 编辑区：左侧 textarea + 右侧预览（或顶部 Tab 切换），预览用与 InfoFeed 详情共用的 ReactMarkdown + feed-markdown.css
  - 插入图片：提供“插入图片”按钮 → 调用上传 API → 在光标处插入 `![](url)`
  - 保存：创建/更新；成功后返回列表或停留在编辑页

4) 统一状态与类型
- 复用 InfoFeedStatus 的三态（draft/published/archived）；后端字段直接存对应字符串。
- 前端类型：新增 `News`/`NewsListQuery`/`NewsSaveRequest` 等，状态字段使用 `InfoFeedStatus`，避免重复枚举。

5) 简洁实现要点
- Markdown：不引入重量级编辑器，采用 textarea + 预览即可；渲染严格共用 feed-markdown.css 与自定义组件（图片 skeleton 等）。
- 上传：使用现有静态目录 `/uploads`，按日期分目录；仅返回 URL，前端负责把 URL 写入 Markdown。
- 过滤：后端 SQL 用 `LIKE` + 参数化；分类/状态为空则不加过滤条件。
- 分页：简单 page/limit，避免复杂游标。
- 错误处理：沿用项目的 ApiError/DatabaseError 处理模式。

接口草案（前端调用路径）
- GET `/api/admin/news` → 列表
- GET `/api/admin/news/:id` → 详情
- POST `/api/admin/news` → 创建
- PUT `/api/admin/news/:id` → 更新
- DELETE `/api/admin/news/:id` → 删除
- PUT `/api/admin/news/:id/status` → 切换状态
- POST `/api/admin/news/upload` → 上传图片（返回 { url }[]）

SQL 输出
- 文件：`backend/sql/news/create_news_tables.sql`
- 仅在需要时追加：索引优化、迁移脚本（新增列等）

完成标准（本阶段）
- 后端：上述接口可用；图片上传能返回可访问的 URL；权限控制正确；与 InfoFeed 状态语义一致。
- 前端：列表页可查询/过滤/删除；编辑页可编辑 Markdown 并预览、可插入图片、可保存；两处均可切换状态。

后续可选（不在本阶段）
- 批量操作（批量删除/批量发布）
- 草稿自动保存/编辑审计
- 更丰富的分类/标签体系

